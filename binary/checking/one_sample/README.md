# Введение

Проведено исследование 
последовательного анализа для одновыборочного случая.
По итогам этого исследования мы можем утверждать, что:
* методика _корректна_, так как вероятность ошибки
не больше заданной;
* последовательный анализ позволяет _ускорить_
проверку гипотез на десятки процентов;
* мы можем с хорошей точностью вычислять
_среднюю длительность_ теста в случае последовательного анализа
для односторонней (право- или левосторонней) альтернативы.

Далее подробности исследования.

## Оглавление
1. [Корректность последовательного анализа](#корректность-последовательного-анализа)
   1. [Методология](#методология-проверки-корректности)
   2. [Результаты](#результаты-моделирования-корректности)
   3. [Материалы](#материалы-проверки-корректности)
2. [Сравнение длительности теста в классическом дизайне со средней длительностью теста в последовательном анализе](#сравнение-длительности-теста-в-классическом-дизайне-со-средней-длительностью-теста-в-последовательном-анализе)
   1. [Методология](#методология-сравнения)
   2. [Результаты моделирования сравнения](#результаты-моделирования-сравнения)
   3. [Материалы](#материалы-сравнения)
3. [Точность формулы длительности теста](#точность-формулы-длительности-теста)
   1. [Методология](#методология-оценки-точности)
   2. [Результаты](#результаты-моделирования-оценки-точности)
   3. [Материалы](#материалы-оценки-точности)
4. [Архитектура исследования](#архитектура-исследования)

# Корректность последовательного анализа

## Методология проверки корректности

Методику можно считать корректной,
если вероятности ошибок I и II рода
не превосходят заранее заданных.
Для этого фиксируются:
* истинная вероятность (конверсия) `p`;
* вероятность `p0` при гипотезе;
* MDE `d`;
* уровень значимости (ограничение на вероятность ошибки I рода) `alpha`;
* 1 - мощность (ограничение на вероятность ошибки II рода) `beta`;
* количество синтетических тестов `iter_size`.

Далее параллельно моделируется `iter_size` раз тестов
и рассчитывается количество принятых решений.
В зависимости от альтернативы и типа вероятности ошибки
выбираются значения параметра `p`
и тип решений, которые приводят к выбранному типу ошибки.
Если частота таких решений будет не больше вероятности ошибки
выбранного типа, то методика корректна.

Ниже приведена таблица сопоставлений
фиксироанным альтернативе и типу вероятности ошибки
выбираемые значения `p` и типа наблюдаемых решений,
которые являются ошибочными.

| Альтернатива   | Тип вероятности ошибки | `p`    | Тип ошибочных решений                                  |
|----------------|------------------------|--------|--------------------------------------------------------|
| Правосторонняя | I рода                 | `p0`   | Стат. значимый рост                                    |
| Правосторонняя | II рода                | `p0+d` | Не стат. значимый рост                                 |
| Левосторонняя  | I рода                 | `p0`   | Стат. значимое падение                                 |
| Левосторонняя  | II рода                | `p0-d` | Не стат. значимое падение                              |
| Двусторонняя   | I рода                 | `p0`   | Стат. значимое изменение                               |
| Двусторонняя   | II рода                | `p0-d` | Не стат. значимое изменение или стат. значимый рост    |
| Двусторонняя   | II рода                | `p0+d` | Не стат. значимое изменение или стат. значимое падение |

## Результаты моделирования корректности

При любых значениях `p0` и `d`
вероятность ошибки не больше заданного значения.
Однако при некоторых значениях `p0` и `d`
реальная веротяность ошибки 
может быть меньше заданных значений.
* При `p0` = 50% и большом изменении (на 20% относительно и больше)
вероятность ошибки меньше заданного значения.
* При больших up-lift и `p0` около 100%
или down-lift и `p0` около 0% 
вероятность ошибки II меньше заданного значения.

## Материалы проверки корректности

Исследование проведено в блокноте
[error_probability.ipynb](error_probability.ipynb).
В исследовании для большого спектра параметров
приведены графики частот ошибок.

# Сравнение длительности теста в классическом дизайне со средней длительностью теста в последовательном анализе

## Методология сравнения

Сравнение будет проводиться с помощью моделирования, как это описано 
в [методологии проверки корректности](#методология-проверки-корректности).

При классическом анализе длительность теста фиксирована
и размер выборки определяется заранее,
исходя их некоторых параметров теста.
При последовательном анализе длительность теста случайна,
поэтому мы рассматриваем среднюю длительность теста.
В качестве показателя эффективности последовательного анализа
мы будем рассматривать 
`размер выборки при классическом дизайне теста` 
/ `средняя длительности теста при последовательном анализе`.

Распределение длительности теста
при последовательном анализе вообще говоря зависит
от значения истинной вероятности `p` (конверсии).
Поэтому мы рассмотрим:
* среднюю длительность теста при гипотезе (`p = p0`);
* среднюю длительность теста при альтернативе (`p` отличается от `p0` на `d`);
* максимальное значение средней длительность теста
при всех возможных значениях параметра `p`.

## Результаты моделирования сравнения

Сводная таблица моделирования отношений длительностей теста.

| Альтернатива / Распределение | Худший случай | При гипотезе | При альтернативе |
|------------------------------|---------------|--------------|------------------|
| Правосторонняя               | 1.14 ~ 1.38   | 1.97 ~ 2.27  | 1.35 ~ 1.61      |
| Левосторонняя                | 1.14 ~ 1.39   | 1.97 ~ 2.47  | 1.35 ~ 1.61      |
| Двусторонняя                 | 1.08 ~ 1.27   | 1.42 ~ 1.62  | 1.32 ~ 2.00      |

Минимальные значения отношений достигаются 
при `p0` = 50% и больших значениях MDE.
Это связано с тем, что при этих же значениях параметров
вероятности ошибок меньше установленных значений.
Если же истинные значения вероятностей ошибок
примерно совпадают с заданными значениями,
средние значения отношений длительностей теста
приближаются к максимальным значениям в таблице.

## Материалы сравнения

Исследование проведено в блокноте
[sample_size.ipynb](sample_size.ipynb).
В исследовании для большого спектра параметров
приведены таблицы отношений длительностей тестов.

# Точность формулы длительности теста

## Методология оценки точности

Сравнение будет проводиться с помощью моделирования, как это описано 
в [методологии сравнения](#методология-сравнения).

При классическом анализе длительность теста
есть калькуляторы, позволяющие оценить длительность теста.
В случае последовательного анализа выводится формула,
позволяющая оценить среднюю длительность последовательного теста.
В этом разделе проводится сравнение средней длительности теста
из моделирования и значения формулы средней длительности
последовательного теста.
Для этого мы будем рассматривать относительную ошибку
оценки средней длительности теста.

Распределение длительности теста
при последовательном анализе вообще говоря зависит
от значения истинной вероятности `p` (конверсии).
Поэтому мы рассмотрим:
* относительную ошибку при гипотезе (`p = p0`);
* относительную ошибку при альтернативе (`p` отличается от `p0` на `d`);
* максимальное значение относительной ошибки
при всех возможных значениях параметра `p`.

## Результаты моделирования оценки точности

Сводная таблица моделирования отношений длительностей теста.

| Альтернатива / Распределение | Худший случай  | При гипотезе   | При альтернативе |
|------------------------------|----------------|----------------|------------------|
| Правосторонняя               | 1.07% ~ 25.53% | 0.07% ~ 16.26% | 0.77% ~ 13.00%   |
| Левосторонняя                | 1.69% ~ 26.09% | 0.39% ~ 17.66% | 0.27% ~ 13.95%   |

Минимальные значения отношений достигаются при MDE = 50%.
Это связано с тем, что при этих же значениях параметров
вероятности ошибок меньше установленных значений.
При меньших MDE относительная ошибка в разы меньше,
и обычно не превышает 5%.

## Материалы оценки точности

Исследование проведено в блокноте
[sample_size_calculator.ipynb](sample_size_calculator.ipynb).
В исследовании для большого спектра параметров
приведены таблицы относительных ошибок оценки точности.

# Архитектура исследования

Архитектура последовательного анализа сильно оптимизирована
под проведение моделирования как можно быстрее,
так как каждое моделирование проводится несколько часов.

Центральным местом моделирования являются функции,
позволяющие принимать решения на основе входящих данных.
Так как реализация последовательного анализа
для односторонней и двусторонней альтернатив
существенно различаются,
сделано две реализации:
* для односторонней альтернативы - [one_sample_one_sided_sprt](../one_sample_one_sided_sprt.py);
* для двусторонней альтернативы - [one_sample_two_sided_sprt](../one_sample_two_sided_sprt.py).

Они используются в скрипте
[simulation](simulation.py),
который под заданные параметры распределений 
проводит серию моделированием
с подведением статистики этих моделирований.

Также в реализации моделирования участвуют:
* формула длительности классического теста - [one_sample_classic_sample_size](../one_sample_classic_sample_size.py);
* формула длительности последовательного теста - [one_sample_sequential_sample_size](../one_sample_sequential_sample_size.py).
